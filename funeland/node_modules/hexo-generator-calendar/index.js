/* global hexo */
'use strict';

const fs = require('fs');
const path = require('path');

hexo.extend.generator.register('calendar', calendar);

function calendar(locals) {

  let config = this.config;
  let posts = locals.posts.sort('-date');

  let data = {};

  //get taxonomies data for generator
  posts.forEach((post) => {
    let date = post.date;
    let obj = date.toObject();
    let year = obj.years;
    let month = obj.months;
    let day = obj.date;
    if (!data[year]) data[year] = {};
    if (!data[year][month]) data[year][month] = {};
    if (!data[year][month][day]) data[year][month][day] = true;
  });

  let base_dir = hexo.base_dir;
  let route = hexo.route;
  let tmp = JSON.stringify(data);
  let con = fs.readFileSync(path.join(__dirname, './pikaday.js'), 'utf-8');
  con = con.replace('{data}', tmp);
  route.set('/js/pikaday.js', con);
};
